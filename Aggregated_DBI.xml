<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient[]>
<!-- Saved on Saturday, June 30, 2007, 10:48  -->
<!-- MuClient version 4.13 -->

<!-- Plugin "Aggregated DBI Tool" generated by Plugin Wizard -->

<!--
Keeps track of a bunch of prompt/combat/meditate/focus/general info to give you redux statistics and reduced spam.
-->

<muclient>
<plugin
   name="Aggregated_DBI"
   author="Rhozo"   
   id="703dbfca1423310152c475a3"
   language="Lua"
   purpose="Scrapes output to give you statistics on all sorts of stuff."
   date_written="2015-10-10 03:50:00"
   requires="4.08"
   version="1.0"
   >
<description trim="y">
<![CDATA[
Records to the various messages in the MUD Prompt/med/focus to report statistics for the user.
]]>
</description>

</plugin>

<!--  Triggers  -->

<triggers>
	<trigger
		enabled="y"
		match="^Welcome to the DragonBall Infinity.  A MUD based on the DragonBall,"
		omit_from_output="n"
		regexp="y"
		script="onConnect"
		sequence="100"
	>
	</trigger>
	
	<trigger
		enabled="y"
		match="^You begin to meditate..."
		omit_from_output="y"
		regexp="y"
		script="onStartMeditate"
		sequence="100"
	>
	</trigger>

	<trigger
		enabled="y"
		match="^You begin to focus your ki into your body..."
		omit_from_output="y"
		regexp="y"
		script="onStartFocus"
		sequence="100"
	>
	</trigger>
	
	<trigger
		enabled="y"
		match="^You meditate peacefully, collecting energy from the cosmos*"
		omit_from_output="y"
		regexp="y"
		script="onTickMeditate"
		sequence="100"
	>
	</trigger>

	<trigger
		enabled="y"
		match="^You focus your ki into your body, your cells absorbing the ambient energy."
		omit_from_output="y"
		regexp="y"
		script="onTickFocus"
		sequence="100"
	>
	</trigger>
		
	<trigger
		enabled="y"
		match="^You stop meditating..."
		omit_from_output="y"
		regexp="y"
		script="onStopMeditate"
		sequence="100"
	>
	</trigger>

	<trigger
		enabled="y"
		match="^You stop concentrating..."
		omit_from_output="y"
		regexp="y"
		script="onStopFocus"
		sequence="100"
	>
	</trigger>
	
	<trigger
		enabled="y"
		match="^.*Your (powerlevel|techlevel) increases by (.*) points."
		omit_from_output="y"
		regexp="y"
		script="onGainedPL"
		sequence="100"
	>
	</trigger>

	<trigger
		enabled="y"
		match="^.*You gain (.*) ki. Your max ki is now (.*)."
		omit_from_output="y"
		regexp="y"
		script="onGainedKi"
		sequence="100"
	>
	</trigger>
	
	<trigger	
		enabled="y"
		match="^.* K:(.*) P:.*$"
		omit_from_output="y"
		regexp="y"
		script="onPromptCheck"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^.* E:(.*) T:.*$"
		omit_from_output="y"
		regexp="y"
		script="onPromptCheck"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^H\[.*\] K\[(.*)/(.*)\] F\[.*\]"
		omit_from_output="n"
		regexp="y"
		script="onPromptCheck"
		keep_evaluating="y"
		sequence="5"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^H\[(.*)\] K\[(.*)/(.*)\] F\[(.*)\]$"
		omit_from_output="y"
		regexp="y"
		script="onPromptScrape"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^H\[(.*)\] V\[(.*)\] K\[(.*)/(.*)\] F\[(.*)\]$"
		omit_from_output="y"
		regexp="y"
		script="onBattlePromptScrape"
		sequence="99"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^P\[(.*)\|(.*)\] \$\[\$(.*)\] A\[(.*)/(.*)\] B\[(.*)\]$"
		omit_from_output="y"
		regexp="y"
		script="onPromptScrape2"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(.*) is DEAD!!$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onEndCombat"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^You stab (.*) in the chest with your tail and suck out (.*) life force\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onEndCombat"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="^..Everything begins to fade to black.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onKilled"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^You get (.*) zeni from the corpse of (.*)$"
		omit_from_output="y"
		regexp="y"
		script="onGetZeni"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^Picard gives you nothing for your sacrifice.$"
		omit_from_output="y"
		regexp="y"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^I see nothing in the corpse.$"
		omit_from_output="y"
		regexp="y"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You must stand to do that!$"
		omit_from_output="y"
		regexp="y"
		script="printStand"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You need to focus more.$"
		omit_from_output="y"
		regexp="y"
		script="onNeedFocus"
		sequence="100"
	>	
	</trigger>

	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) hits you, but you soak the damage\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onSoak"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) hits you. You laugh at .* weak power\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onSoak"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*)'s hit is absorbed by the ki energy surrounding you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onSoak"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You cross your arms and block (?P<foename>.*)'s hit\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onSoak"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) lands .* hit but you just grin at .*\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onSoak"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You block (?P<foename>.*)'s physical attack\.$"
		omit_from_output="y"
		regexp="y"
		script="onBlock"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You dodge (?P<foename>.*)'s hit with incredible speed\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) overextends .* and misses you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) trips on something and misses you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) aims too (low|high) and misses you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>	
		
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) loses concentration for a moment and misses you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You chuckle as (?P<foename>.*) goes off-balance by missing you\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You (duck under|jump over) (?P<foename>.*)'s attack\. \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) misses you\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemyMiss"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You dodge (?P<foename>.*)'s physical attack\.$"
		omit_from_output="y"
		regexp="y"
		script="onDodge"
		sequence="100"
	>	
	</trigger>	
	
	<trigger
		enabled="y"
		match="^(\)|)\s*You miss (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You get laughed at by (?P<foename>.*) for your off-balance miss\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You lose concentration for a moment and miss (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You aim too (high|low) and miss (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) (jumps over|ducks under) your attack\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) dodges your hit with incredible speed\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You trip on something and miss (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 	
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You overextend yourself and miss (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onMiss"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) crosses .* arms and blocks your hit\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemySoak"
		sequence="100"
	>	
	</trigger> 	

	<trigger	
		enabled="y"
		match="^(\)|)\s*You hit (?P<foename>.+?) but (he|she|it+?) seems to shrug off the damage\.  \[0\]$"
		omit_from_output="y"
		keep_evaluating="n"
		regexp="y"
		script="onEnemySoak"
		sequence="99"
	>	
	</trigger> 	

	<trigger	
		enabled="y"
		match="^(\)|)\s*You land your hit but (?P<foename>.*) just grins at you\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemySoak"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You hit (?P<foename>.+?)\.\s(.+?)\sjust laughs at your weak power\. \[0\]$"
		omit_from_output="y"
		keep_evaluating="n"
		regexp="y"
		script="onEnemySoak"
		sequence="99"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*Your hit is absorbed by the ki energy surrounding (?P<foename>.*)\.  \[0\]$"
		omit_from_output="y"
		regexp="y"
		script="onEnemySoak"
		sequence="100"
	>	
	</trigger> 
	
	<trigger	
		enabled="y"
		match="^(\)|)\s*You (tickle|brush|scratch|tear|cut|graze|nick|jolt|wound|_traumatize_|injure|gash|lacerate|rip|_devastate_|_mangle_|_maim_|DISEMBOWEL|_cleave_|_demolish_|GUT|hack|decimate|thrash|maul|jar|hit|PULVERIZE|MASSACRE|MUTILATE|DESTROY|\*\*\*\* ATOMIZE \*\*\*\*|\*\*\* ANNIHILATE \*\*\*|\* VAPORIZE \*|\* LIQUIFY \*|\* OBLITERATE \*)\s+(?P<foename>.*)(\!|\.)\s+\[(?P<damage>.*)\]$"
		omit_from_output="y"
		regexp="y"
		script="onDealDamage"
		sequence="100"
	>	
	</trigger> 

	<trigger	
		enabled="y"
		match="^(\)|)\s*(?P<foename>.*) (tickles|brushes|scratches|tears|cuts|grazes|nicks|jolts|wounds|_traumatizes_|injures|decimates|gashes|lacerates|rips|_devastates_|_mangles_|_maims_|DISEMBOWELS|_cleaves_|_demolishes_|GUTS|hacks|thrashes|mauls|jars|hits|PULVERIZES|MASSACRES|MUTILATES|DESTROYS|\*\*\*\* ATOMIZES \*\*\*\*|\*\*\* ANNIHILATES \*\*\*|\* VAPORIZES \*|\* LIQUIFIES \*|\* OBLITERATES \*) you(\!|\.)\s+\[(?P<damage>.*)\]$"
		omit_from_output="y"
		regexp="y"
		script="onTakeDamage"
		sequence="100"
	>	
	</trigger> 	
	
	<trigger	
		enabled="y"
		match="^Total (powerlevel|techlevel) gained this fight: (.*)$"
		omit_from_output="y"
		regexp="y"
		script="onGainCombatPL"
		sequence="100"
	>	
	</trigger> 	
	
	<trigger	
		enabled="y"
		match="^H\[(.*)\] V\[(.*)\] K\[(.*)/(.*)\] F\[(.*)\]$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onPromptShowRoundInfo"
		sequence="98"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^You turn the dial to (?P<timesGravity>.*) times gravity and begin training your (?P<trainingStat>.*)\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onStartTraining"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^Your (?P<trainingStat>.*) has reached its peak for now\.$"
		omit_from_output="n"
		keep_evaluating="y"
		regexp="y"
		script="onStopTraining"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^You take a break and stop training your (?P<trainingStat>.*)\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onStopTraining"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^You stop training your (?P<trainingStat>.*)\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onStopTraining"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^You get (?P<itemName>.*) from the corpse of (?P<foeName>.*)$"
		omit_from_output="n"
		keep_evaluating="y"
		regexp="y"
		script="onLootDrop"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^You gained 5 additional training points!$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onEarnedTrains"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^You try to allow your mind to grasp the excess energies of the leylines flowing$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^Energy from the leylines pulses in your veins as you wave your$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^through you, but the mana current escapes your grasp...$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onThoughtcraftFail"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^hands and create a psychic crystal with the excess energy."
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onThoughtcraftSucceed"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^and collect and merge with your own."
		omit_from_output="n"
		keep_evaluating="y"
		regexp="y"
		script="onThoughtcraftStart"
		sequence="100"
	>	
	</trigger>	
	
	<trigger	
		enabled="y"
		match="^You open your eyes and stop trying to create shards."
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onThoughtcraftStop"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The hologram screens throughout the base display a repeating message, &quot;Train hard and one day you too can be Ginyu!&quot;$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The Ship hums and shakes, the sounds of busy bodies resounding through the ship\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^Vultures begin to circle in the sky overhead\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A thick fog rolls through the area\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A cool breeze breathes fresh life onto the planet\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The howling winds pierce your body, chilling you to the bone\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The sacred chimes of the temple ring through the valley\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^It feels like you've seen this all before somewhere\.\.\.\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The sounds of science and technlology can be heard and felt all around you\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The pure evil of this place tries to crawl into your soul\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The sounds of the forest's wild life can be heard every where\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The sounds of combat and heavy training are quite prevalent in this area\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A roar in the sky signals a new wave of arriving spaceships heading towards the massive spaceport of Feldron\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The dark energy in this place clouds all senses\.\.\.\.\.\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A flash of crimson lightning splits the sky\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A solar wind pushes the asteroid, shaking the remaining foundations of the Cordican\.\.\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^A solar wind passes over the asteroid, slowly eroding the remnants of the Leviathan\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^The symphonies of Kayin transition into the next movement\.$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onAreaReset"
		sequence="100"
	>	
	</trigger>
	
	<trigger	
		enabled="y"
		match="^You surge with new found power as you learn (?P<skillName>.*)$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onBioSkillAbsorb"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="^(You push Goku away from food.|You halt the planets rotation with your bare hands.|You bench press Jack Thompson's ego.|You smash through solid steel walls.|You pull apart two strong magnets.|You stop a speeding bus with one hand.|You wrestle a massive metal droid.)$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onTrainingFlavorText"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="^(You attempt to dodge kicks from Chuck Norris.|You attempt to outrun your energy blast.|You attempt to outrun a cheetah.|You attempt to dodge kicks from Jet Li.|You attempt to keep up with a rave.|You try to steal Master Roshi's magazines.|You try to run from Mephablo.|You dodge energy blasts from training droids.|You race a fat person to the buffet line.|You juggle small kittens.)$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onTrainingFlavorText"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="^(You try to lift water from a glass with your mind.|You create energy balls.|You meditate under a waterfall.|You raise and lower your powerlevel.|You attempt to focus while being bombarded with energy blasts.|You attempt to read Chi-chi's mind.|You attempt to figure out Jack Thompson's logic.|You change the color of your aura back and forth.|You fire rapid energy blasts in quick succession.|You allow your power to push beyond it's max for a moment.|You fire energy blasts at training droids.|You force your power to double it's normal limit for a moment.|You cause your powerlevel to spike madly.)$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onTrainingFlavorText"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="^(You listen to Borfin complain.|You break dance.|You deal with Chi-chi's nagging.|You are trampled by a group of Good Charlotte groupies.|You allow energy blasts to slam into you.|You sit through an Uwe Boll movie.|You are hit by training droids.|You are chewed up by a dinosaur.)$"
		omit_from_output="y"
		keep_evaluating="y"
		regexp="y"
		script="onTrainingFlavorText"
		sequence="100"
	>	
	</trigger>
	
	<trigger
		enabled="y"
		match="\AAn Empty Room\s+This room is rather plain and simple.  There isn't really anything in\s+here.  There is a picture on the wall, a rug on the floor and a table\s+aginst the north part of the wall. It looks like there is an outline of a\s+circle in the middle of the rug.\s+=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\Z"
		omit_from_output="n"
		lines_to_match="6"
		multi_line="y"
		keep_evaluating="y"
		regexp="y"
		script="onEnter5bWarning"
		sequence="100"
	>	
	</trigger>
 
	  <trigger
	   enabled="y"
	   match="^$"
	   omit_from_output="y"
	   regexp="y"
	   sequence="100"
	  >
	  </trigger> 
	
	
</triggers>

<aliases>
<alias
match="^session$"
enabled="y"
expand_variables="y"
regexp="y"
keep_evaluating="y"
send_to="12"
script="onReportGains"
sequence="100"
>
</alias>
<alias
match="^clear$"
enabled="y"
expand_variables="y"
regexp="y"
keep_evaluating="y"
send_to="12"
script="onConnect"
sequence="100"
>
<send>
Note("Cleared local variables.")
</send>
</alias>
<alias
match="^setBattlePrompt$"
enabled="y"
expand_variables="y"
regexp="y"
keep_evaluating="n"
send_to="12"
sequence="100"
script="setBattlePrompt"
>
</alias>

<alias
match="^setPrompt$"
enabled="y"
expand_variables="y"
regexp="y"
keep_evaluating="n"
send_to="12"
sequence="100"
script="setPrompt"
>
</alias>

<alias
match="^test$"
enabled="y"
expand_variables="y"
regexp="y"
keep_evaluating="n"
send_to="12"
sequence="100"
script="debugPrompt"
>
</alias>

</aliases>

<!--  Script  -->

<script>
<![CDATA[

--causes max ki to show up instead of just percentages in prompt, defaults to false.
local show_max_ki = false

--causes end-of-fight summaries to show up after combat, defaults to false.
local show_battle_synopsis = false

--causes end of med/foc to show session averages, defaults to false
local show_ki_synopsis = false

local original_max_ki = 0.0
local current_ki = 0.0
local max_ki = 0.0
local current_gained_pl = 0.0
local total_gained_pl = 0.0
local current_gained_ki = 0.0
local total_gained_ki = 0.0
local current_meditate_ticks = 0.0
local current_focus_ticks = 0.0
local total_meditate_ticks = 0.0
local total_focus_ticks = 0.0
local last_meditate_tick = GetInfo(232)
local last_focus_tick = GetInfo(232)
local current_elapsed_meditate_time = 0.0
local current_elapsed_focus_time = 0.0
local total_elapsed_meditate_time = 0.0
local total_elapsed_focus_time = 0.0
local in_focus = false
local in_meditate = false
local ki_gain_string1 = ""
local ki_gain_string2 = ""
local ki_gain_string3 = ""
local ki_gain_string4 = ""
local ki_gain_string5 = ""
local pl_gain_string1 = ""
local pl_gain_string2 = ""
local pl_gain_string3 = ""
local pl_gain_string4 = ""
local is_low_on_focus = false
local biomass = 0

local percent_lookup_table = {10, 19, 28, 37, 46, 55, 64, 73, 82, 91, 100}
local armor_percent_lookup_table = {80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100}
local color_percent_lookup_table = {"red", "orangered", "darkorange", "orange", "gold", "yellow", "greenyellow", "lawngreen", "lightgreen", "palegreen", "cyan"}

function color_from_percent(percent)
	local percent_forced_numeric = tonumber(percent)
	local lowest_value_index = 11
	for i=1, 11 do
		if percent_forced_numeric <= percent_lookup_table[i] and i <= lowest_value_index then
			lowest_value_index = i		
		end	
	end	
	return color_percent_lookup_table[lowest_value_index]
end

function armor_color_from_percent(percent)
	local percent_forced_numeric = tonumber(percent)
	local highest_value_index = 11
	for i=1, 11 do
		if percent_forced_numeric <= armor_percent_lookup_table[i] and i <= highest_value_index then
			highest_value_index = i		
		end	
	end
	return color_percent_lookup_table[highest_value_index]
end

--tells the script you've already gotten the meditate message from promptCheck, prevents it from firing more than once in a round
local already_received_meditate_message = false

local is_out_of_ki = false
local is_at_max_ki = false

local absolute_start_time = GetInfo(232)

local health = 0
local foe_health = 0
local current_focus = 0
local max_focus = 0
--PL here is a string, it's cool.
local base_pl = 0
local max_pl = 0
local zeni = 0
local current_armor = 0
local max_armor = 0

local combat_round_pl_gained = 0
local training_pl_gained = 0
local total_training_pl_gained = 0

local combat_pl = 0
local attacks = 0
local defends = 0
local blocks = 0
local dodges = 0
local misses = 0
local enemy_misses = 0
local soaks = 0
local enemy_soaks = 0
local hits = 0
local enemy_hits = 0
local combats = 0

local damage_dealt = 0
local damage_received = 0
	
local total_damage_dealt = 0
local total_damage_received = 0

local total_attacks = 0
local total_defends = 0
local total_blocks = 0
local total_dodges = 0
local total_misses = 0
local total_enemy_misses = 0
local total_soaks = 0
local total_enemy_soaks = 0
local total_hits = 0
local total_enemy_hits = 0

local overkill_counter = 0

local damage_dealt_since_last_round = 0
local hits_since_last_round = 0
local damage_received_since_last_round = 0
local hits_received_since_last_round = 0

local foe_name = ""

local times_gravity = 0
local training_stat = ""
local training_flavor_text = ""

local thoughtcraft_attempts = 0
local thoughtcraft_successes = 0

local windowName = "dbiAggregationWindow" .. GetPluginID()
local promptWindow = windowName .. "Prompt"
local currentWindow = windowName .. "Current"
local combatWindow = windowName .. "Combat"
local combatWindow2 = windowName .. "Combat2"

local prompt_tick_flag = true
	
function resetMedFocValues()
	original_max_ki = 0.0
	current_ki = 0.0
	max_ki = 0.0
	biomass = 0
	current_gained_pl = 0.0
	total_gained_pl = 0.0
	current_gained_ki = 0.0
	total_gained_ki = 0.0
	current_meditate_ticks = 0.0
	current_focus_ticks = 0.0
	total_meditate_ticks = 0.0
	total_focus_ticks = 0.0
	last_meditate_tick = GetInfo(232)
	last_focus_tick = GetInfo(232)
	current_elapsed_meditate_time = 0.0
	current_elapsed_focus_time = 0.0
	total_elapsed_meditate_time = 0.0
	total_elapsed_focus_time = 0.0
	in_focus = false
	in_meditate = false
	combat_round_pl_gained = 0
	is_low_on_focus = false
	ki_gain_string1 = ""
	ki_gain_string2 = ""
	ki_gain_string3 = ""
	ki_gain_string4 = ""
	ki_gain_string5 = ""
	pl_gain_string1 = ""
	pl_gain_string2 = ""
	pl_gain_string3 = ""
	pl_gain_string4 = ""
end

function resetPromptValues()
	health = 0
	foe_health = 0
	current_focus = 0
	max_focus = 0
	
	base_pl = 0
	max_pl = 0
	zeni = 0
	current_armor = 0
	max_armor = 0
	
	times_gravity = 0
	training_stat = ""
	training_flavor_text = ""
	training_pl_gained = 0
	total_training_pl_gained = 0
	
	thoughtcraft_attempts = 0
	thoughtcraft_successes = 0
end

function OnPluginInstall ()
	initializeWindows()
end -- OnPluginInstall

function onConnect(name, line, wildcards, styles)	
	--responsible for resetting all the internal variables to their meaningful defaults
	--this is to prevent DCs and reboots from affecting your performance aggregation totals.
	--it's also called by "clear" to wipe all the info and let you start fresh.
	resetMedFocValues()
		
	resetPromptValues()

	resetCombatValues()
	
	initializeWindows()

	absolute_start_time = GetInfo(232)
end

function initializeWindows()
	initializeWindow(currentWindow)
	initializeWindow(promptWindow)
	initializeWindow(combatWindow)
	initializeWindow(combatWindow2)

	-- find height of font for future calculations             
	--font_height = WindowFontInfo (promptWindow, font_id, 1)  -- height
		
	TextRectangle(0, 0, 50 + GetInfo(213) * 80,
		-80, 5, ColourNameToRGB("silver"),
		1,
		ColourNameToRGB("black"),
		1)
		
	WindowSetZOrder(currentWindow, 0)
	WindowSetZOrder(promptWindow, 1)
	WindowSetZOrder(combatWindow, 2)
	WindowSetZOrder(combatWindow2, 3)
	
	purgeCurrentWindow()
	purgePromptWindow()
	purgeCombatWindow()
	purgeCombatWindow2()
end

function initializeWindow(windowNameString)
	font_id = "fn"
	bold_font_id = "fb"
  
	font_name = "Fixedsys"    -- the actual font
	font_size = 9
	
	-- make window so I can grab the font info
	WindowCreate (windowNameString, 
		0, 0, 0, 0,  -- empty window
		miniwin.pos_top_left,   -- position (irrelevant)
		0,   -- flags (none)
		0)   -- background colour (black - irrelevant)
                
	-- add font in normal and bold styles                 
	WindowFont (windowNameString, font_id, font_name, font_size, 
		false, false, false, false,  -- normal
		miniwin.font_charset_ansi, miniwin.font_family_any)
				  
	WindowFont (windowNameString, bold_font_id, font_name, font_size, 
		true, false, false, false,   -- bold
		miniwin.font_charset_ansi, miniwin.font_family_any)
end

function purgeCurrentWindow()
	WindowCreate(currentWindow, 0, 0, 50 + GetInfo(213) * 80, 64, miniwin.pos_bottom_left, 0, ColourNameToRGB("black"))
	WindowShow(currentWindow, true)
end

function purgePromptWindow()
	WindowCreate(promptWindow, 0, 0, 50 + GetInfo(213) * 80, 48, miniwin.pos_bottom_left, 0, ColourNameToRGB("black"))
	WindowShow(promptWindow, true)
end

function purgeCombatWindow()
	WindowCreate(combatWindow, 0, 0, 50 + GetInfo(213) * 80, 32, miniwin.pos_bottom_left, 0, ColourNameToRGB("black"))
	WindowShow(combatWindow, true)
end

function purgeCombatWindow2()
	WindowCreate(combatWindow2, 0, 0, 50 + GetInfo(213) * 80, 16, miniwin.pos_bottom_left, 0, ColourNameToRGB("black"))
	WindowShow(combatWindow2, true)
end

function onStartMeditate(name, line, wildcards, styles)	
	if in_meditate == false then
		--reset all counters
		last_meditate_tick = GetInfo(232)	
		current_meditate_ticks = 0.0
		current_elapsed_meditate_time = 0.0
		current_gained_pl = 0.0
		
		in_meditate = true
	end
end
 
function onStopMeditate(name, line, wildcards, styles)
	if in_meditate then			
		purgeCurrentWindow()
		ColourTell("red", "black", "Meditate stopped!")
		if is_at_max_ki then
			ColourTell("green", "black", "(", "yellow", "black", "maxed!", "green", "black", ")\n")
			printFocusKi()
			is_at_max_ki = false
		else
			ColourTell("green", "black", "\n")
		end
		
		--aggregate all counters		
		total_meditate_ticks = total_meditate_ticks + current_meditate_ticks	
		total_elapsed_meditate_time = total_elapsed_meditate_time + current_elapsed_meditate_time
		total_gained_pl = total_gained_pl + current_gained_pl	
	
		local current_ticks_over_time = 0.0
		local current_gained_pl_per_tick = 0.0
		local current_gained_pl_per_second = 0.0
		
		if current_elapsed_meditate_time > 0 then
			current_gained_pl_per_second = current_gained_pl / current_elapsed_meditate_time		
			current_ticks_over_time = current_meditate_ticks / current_elapsed_meditate_time
		end
		
		if current_meditate_ticks > 0 then
			current_gained_pl_per_tick = current_gained_pl / current_meditate_ticks
		end
						
		local total_ticks_over_time = 0.0
		local total_gained_pl_per_tick = 0.0
		local total_gained_pl_per_second = 0.0
		
		if total_elapsed_meditate_time > 0 then
			total_ticks_over_time = total_meditate_ticks / total_elapsed_meditate_time
			total_gained_pl_per_second = total_gained_pl / total_elapsed_meditate_time
		end
		
		if total_meditate_ticks > 0 then
			total_gained_pl_per_tick = total_gained_pl / total_meditate_ticks
		end
	
		in_meditate = false
	
		onReportGains(name, line, wildcards)
	end
end

function onStartFocus(name, line, wildcards, styles)
	if in_focus == false then	
		--reset all counters
		last_focus_tick = GetInfo(232)
		current_elapsed_focus_time = 0
		current_gained_ki = 0	
		current_focus_ticks = 0		
		
		in_focus = true
	end
end

function onStopFocus(name, line, wildcards, styles)
	if in_focus then
		ColourTell("red", "black", "Focus stopped!")
		if is_out_of_ki then
			ColourTell("green", "black", "(", "yellow", "black", "empty!", "green", "black", ")\n")
			is_out_of_ki = false
		else
			ColourTell("green", "black", "\n")
		end 
		--aggregate all counters
		total_focus_ticks = total_focus_ticks + current_focus_ticks
		total_elapsed_focus_time = total_elapsed_focus_time + current_elapsed_focus_time
		total_gained_ki = total_gained_ki + current_gained_ki				
	
		local current_ticks_over_time = 0.0
		local current_gained_ki_per_tick = 0.0
		local current_gained_ki_per_second = 0.0
		
		if current_elapsed_focus_time > 0 then
			current_ticks_over_time = current_focus_ticks / current_elapsed_focus_time
			current_gained_ki_per_second = current_gained_ki / current_elapsed_focus_time		
		end
		
		if current_focus_ticks > 0 then
			current_gained_ki_per_tick = current_gained_ki / current_focus_ticks
		end
		
		local total_ticks_over_time = 0.0
		local total_gained_ki_per_tick = 0.0
		local total_gained_ki_per_second = 0.0
		
		if total_elapsed_focus_time > 0 then
			total_ticks_over_time = total_focus_ticks / total_elapsed_focus_time
			total_gained_ki_per_second = total_gained_ki / total_elapsed_focus_time	
		end
		if total_focus_ticks > 0 then
			total_gained_ki_per_tick = total_gained_ki / total_focus_ticks
		end	
		
		if show_ki_synopsis then
		ColourTell("green", "black", "T:",
			"white", "black", tostring(round(current_ticks_over_time)),
			"green", "black", "/s - Ki:",
			"cyan", "black", tostring(round(current_gained_ki_per_tick)),
			"green", "black", "/t - Ki:",
			"cyan", "black", tostring(round(current_gained_ki_per_second)),
			"green", "black", "/s -=- T:",
			"white", "black", tostring(round(total_ticks_over_time)),
			"green", "black", "/s - Ki:",
			"cyan", "black", tostring(round(total_gained_ki_per_tick)),
			"green", "black", "/t - Ki:",
			"cyan", "black", tostring(round(total_gained_ki_per_second)),
			"green", "black", "/s\n"
			)
		end
		in_focus = false
	
		onReportGains(name, line, wildcards)
	end
end

function onTickMeditate (name, line, wildcards, styles)	
	--begin incrementing ticks and saving info
	current_meditate_ticks = current_meditate_ticks + 1	
	local current_meditate_tick = GetInfo(232)	
	local elapsed_meditate_time = roundTime(current_meditate_tick - last_meditate_tick)
	current_elapsed_meditate_time = roundTime(current_elapsed_meditate_time + elapsed_meditate_time)
	last_meditate_tick = current_meditate_tick
	
	pl_gain_string1 = tostring(elapsed_meditate_time)
	pl_gain_string2 = tostring(current_elapsed_meditate_time)
end

function onTickFocus (name, line, wildcards, styles)	
	--begin incrementing ticks and saving info
	current_focus_ticks = current_focus_ticks + 1	
	local current_focus_tick = GetInfo(232)	
	local elapsed_focus_time = roundTime(current_focus_tick - last_focus_tick)
	current_elapsed_focus_time = roundTime(current_elapsed_focus_time + elapsed_focus_time)
	last_focus_tick = current_focus_tick
	
	ki_gain_string1 = tostring(elapsed_focus_time)
	ki_gain_string2 = tostring(current_elapsed_focus_time)	

	purgeCurrentWindow()
	local leftTextPos = 4
	local heightTextStart = 0
	
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "(",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("gray"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Foc",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ")",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("gray"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " Time: ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ki_gain_string2,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " sec. (",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "+" .. ki_gain_string1,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("gray"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ") ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Ki: ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("green"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ki_gain_string4,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("red"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " (",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("green"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "+" .. ki_gain_string3,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("blue"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ") ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("green"), 
				false) -- not Unicode	
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Max: ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("green"), 
				false) -- not Unicode 
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ki_gain_string5,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode 

	ki_gain_string1 = ""
	ki_gain_string2 = ""
	ki_gain_string3 = ""
	ki_gain_string4 = ""
	ki_gain_string5 = ""
end

--ki gained message fires BEFORE the tick message instead of afterwards so I want to concat them to look the same.
function onGainedKi (name, line, wildcards, styles)
	--remove commas
	local ki_gained = tonumber(stripCommas(wildcards[1]), 10)
	local ki_max = tonumber(stripCommas(wildcards[2]), 10)
	
	--get the original ki max if it didn't exist already
	if original_max_ki == 0 then
		original_max_ki = ki_max - ki_gained
	end
	
	--aggregate gains info
	current_gained_ki = current_gained_ki + ki_gained
	max_ki = ki_max
	
	ki_gain_string3 = tostring(ki_gained)
	ki_gain_string4 = shortenNumber(ki_max - original_max_ki)
	ki_gain_string5 = shortenNumber(ki_max)
end

function onPromptCheck (name, line, wildcards, styles)
	--handles comparing your prompt results to whatever is currently in session
	
	current_ki = tonumber(stripCommas(wildcards[1]), 10)	
	
	--if this isn't nil, you're looking at an actual prompt, otherwise something went weird.
	if current_ki then
		if wildcards[2] then
			--this means you're not in an idle prompt
			max_ki = tonumber(stripCommas(wildcards[2]), 10)
		end	
		if (truncate(current_ki * 100.0 / max_ki)) < 20 then
			if in_focus then
				already_received_meditate_message = true
				printMeditate()
			end
		end
	end
	
	--this is prevented from firing at the very end of the training cycle, because training_stat is wiped
	if training_pl_gained > 0 and training_stat ~= "" then
		total_training_pl_gained = total_training_pl_gained + training_pl_gained
		drawTrainingPL()
		training_pl_gained = 0
	end
	
	
	if current_ki == 0 and in_focus then
		is_out_of_ki = true
		onStopFocus (name, line, wildcards, styles)
	end
	
	if current_ki == max_ki and max_ki > 0 and in_meditate then
		is_at_max_ki = true
		onStopMeditate (name, line, wildcards, styles)		
	end
end

function onReportGains (name, line, wildcards)
	local right_now = GetInfo(232)
	local total_elapsed_time = right_now - absolute_start_time
	
	local ki_gained_per_second = 0.0
	local pl_gained_per_second = 0.0
	local current_total_time = total_elapsed_time + current_elapsed_focus_time + current_elapsed_meditate_time
	if current_total_time > 0 then
		ki_gained_per_second = (total_gained_ki + current_gained_ki) / current_total_time
		pl_gained_per_second = (total_gained_pl + current_gained_pl) / current_total_time
	end
	local total_elapsed_time_in_minutes = current_total_time / 60
	
		ColourTell(
			"yellow", "black", "(Ki) Session: ",
			"white", "black", tostring(round(total_elapsed_time_in_minutes)),
			"yellow", "black", " min. - Ki:",
			"red", "black", tostring(round(ki_gained_per_second)),
			"yellow", "black", "/s (",
			"cyan", "black", shortenNumber(total_gained_ki),
			"yellow", "black", ") - PL:",
			"red", "black", tostring(round(pl_gained_per_second)),
			"yellow", "black", "/s (",
			"cyan", "black", shortenNumber(total_gained_pl),
			"yellow", "black", ")\n"
		)
end

function round(num)
  return tonumber(string.format("%." .. (2 or 0) .. "f", num))
end

function roundTime(num) 
	if num >= 0 then return math.floor(num+.5) 
		else return math.ceil(num-.5) end
end

function truncate(num)
  return tonumber(string.format("%." .. (0) .. "f", num))
end

function shortenNumber(num)
	local thousand_counter = 0
	while num >= 1000 do
		thousand_counter = thousand_counter + 1
		num = num / 1000
	end
	
	local lookup_table = {
		[0] = "",
		[1] = "k",
		[2] = "m",
		[3] = "b",
		[4] = "q",
		[5] = "qi",
		[6] = "s",
		[7] = "sp",
		[8] = "o",
		[9] = "n",
		[10] = "d",
		[11] = "v"}
	
	return tostring(round(num)) .. lookup_table[thousand_counter]
end

function expandNumber(num_str)	
	num_str = stripCommas(num_str)
	local lookup_table = {
		["-"] = 0,
		["k"] = 1,
		["m"] = 2,
		["b"] = 3,
		["q"] = 4,
		["qi"] = 5}
		
	local ends_with = string.sub(num_str, -1)
	
	local num = tonumber(num_str, 10)
	
	if tonumber(num_str, 10) ~= nil then
		ends_with = "-"
	else
		num = tonumber(string.sub(num_str, 1, -2), 10)
	end
	
	local thousand_counter = tonumber(lookup_table[ends_with])
	
	while thousand_counter > 0 do
		thousand_counter = thousand_counter - 1
		num = num * 1000
	end
	
	return num
end

function stripCommas(str)
	return string.gsub(str,",","")
end

--handles setting vars and nothing else. The print is in prompt2
function onPromptScrape (name, line, wildcards, styles)
	health = wildcards[1]
	--ki is already handled by an early-sequenced prompt check, we just
	--need to get focus and set the theoretical max
	current_focus = tonumber(stripCommas(wildcards[4]), 10)
	if current_focus then
		if current_focus > max_focus then
		max_focus = current_focus
		end
	end	
end

function onBattlePromptScrape (name, line, wildcards, styles)
	health = wildcards[1]	
	foe_health = tonumber(stripCommas(wildcards[2]), 10)
	--ki is already handled by an early-sequenced prompt check, we just
	--need to get focus and set the theoretical max
	current_focus = tonumber(stripCommas(wildcards[5]), 10)
	if current_focus then
		if current_focus > max_focus then
		max_focus = current_focus
		end
	end
end

function onPromptScrape2 (name, line, wildcards, styles)
	base_pl = expandNumber(wildcards[1])
	current_pl = tonumber(stripCommas(wildcards[2]), 10)
	zeni = tonumber(stripCommas(wildcards[3]), 10)
	current_armor = tonumber(stripCommas(wildcards[4]), 10)
	max_armor = tonumber(stripCommas(wildcards[5]), 10)	
	biomass = tonumber(stripCommas(wildcards[6]), 10)
	current_focus = tonumber(stripCommas(wildcards[5]), 10)
	
	local focus_string = "-"
	
	if max_focus > 0 then
		focus_string = tostring(current_focus)
	end
	
	local focus_color = color_from_percent(current_focus * 100.0 / max_focus)
	
	local armor_string = "-"
	local dr_color = "cyan"
	if max_armor > 0 then
		armor_string = tostring(truncate(current_armor * 100.0 / max_armor))
		dr_color = armor_color_from_percent(current_armor * 100.0 / max_armor)
	end
	
	local foe_string = "-"
	if foe_health > 0 then
		foe_string = tostring(foe_health)
	end
	local dr_string = tostring(math.min(80,truncate(current_armor / 100.0)))
		
	local pl_percentage = current_pl / base_pl
	
	if pl_percentage >= 15 then		
		pl_color = "cyan"
	elseif pl_percentage >= 12 then		
		pl_color = "palegreen"
	elseif pl_percentage >= 9 then		
		pl_color = "lightgreen"
	elseif pl_percentage >= 6 then		
		pl_color = "lawngreen"
	elseif pl_percentage >= 3 then		
		pl_color = "greenyellow"
	elseif pl_percentage >= .99 then		
		pl_color = "yellow"
	elseif pl_percentage >= .8 then		
		pl_color = "gold"
	elseif pl_percentage >= .6 then		
		pl_color = "orange"
	elseif pl_percentage >= .4 then		
		pl_color = "darkorange"
	elseif pl_percentage >= .2 then		
		pl_color = "orangered"
	else
		pl_color = "red"
	end
	
	local ki_color = color_from_percent(current_ki * 100.0 / max_ki)
	if (current_ki * 100.0 / max_ki) < 20 then
		if in_focus then
			if already_received_meditate_message then
				already_received_meditate_message = false
			else
				printMeditate()
			end
		end
	end
	
	purgeCombatWindow2()
	local leftTextPos = 4
	local heightTextStart = 0
	if combat_round_pl_gained > 0 then
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", "  PL: +",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", shortenNumber(combat_round_pl_gained),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode
		combat_round_pl_gained = 0
	end
	if training_pl_gained > 0 then
		total_training_pl_gained = total_training_pl_gained + training_pl_gained
		drawTrainingPL()		
		training_pl_gained = 0
	end	
	
	drawPlayerPrompt(health, foe_string, ki_color, tostring(truncate(current_ki * 100.0 / max_ki)),
		shortenNumber(max_ki), focus_color, focus_string, pl_color, shortenNumber(current_pl), shortenNumber(zeni), dr_color, armor_string, dr_string)
	if is_low_on_focus then
		is_low_on_focus = false
	end
end

function drawTrainingPL()
		leftTextPos = 4
		heightTextStart = 0
		purgeCombatWindow()
		purgeCombatWindow2()
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", training_flavor_text,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("lime"), 
					false) -- not Unicode
		leftTextPos = 4
		heightTextStart = 0
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", "Training (",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", training_stat,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("cyan"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", ") at ",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", shortenNumber(times_gravity),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("cyan"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", " Gs - PL: ",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", shortenNumber(total_training_pl_gained),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("cyan"), 
					false) -- not Unicode 					 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", " (",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", "+" .. shortenNumber(training_pl_gained),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (combatWindow2, "fn", ")",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode 					
end

function onGainedPL (name, line, wildcards, styles)
	--remove commas
	local pl_gained = tonumber(stripCommas(wildcards[2]), 10)
	if in_meditate then 
		--aggregate gains info
		current_gained_pl = current_gained_pl + pl_gained
		
		pl_gain_string3 = shortenNumber(pl_gained)
		pl_gain_string4 = shortenNumber(current_gained_pl)
		
		purgeCurrentWindow()
		local leftTextPos = 4
		local heightTextStart = 0
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "(",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("gray"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Med",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("cyan"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ")",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("gray"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " Time: ",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", pl_gain_string2,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " sec. (",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "+" .. pl_gain_string1,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("gray"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ") ",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "PL: ",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", pl_gain_string4,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " (",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "+" .. pl_gain_string3,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("blue"), 
					false) -- not Unicode 
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ")",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("green"), 
					false) -- not Unicode
					
		pl_gain_string1 = ""
		pl_gain_string2 = ""
		pl_gain_string3 = ""
		pl_gain_string4 = ""
	elseif training_stat ~= "" then
		training_pl_gained = training_pl_gained + pl_gained
	elseif pl_gained > 0 then
		combat_round_pl_gained = combat_round_pl_gained + pl_gained		
	end
end

function drawPlayerPrompt(health_string, foe_string, ki_color, ki_string, max_ki_string, focus_color, focus_string, pl_color, pl_string, zeni_string, armor_color, armor_string, dr_string)
	purgePromptWindow()
	local leftTextPos = 4
	local heightTextStart = 0
	if prompt_tick_flag then
		prompt_tick_flag = false 
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", "* ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode
	else
		prompt_tick_flag = true
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", "  ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode	
	end
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", "H:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", health_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (color_from_percent(health)), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " V:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", foe_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("magenta"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " K:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", ki_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (ki_color), 
				false) -- not Unicode
	if show_max_ki then
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", "/",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", max_ki_string,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB (ki_color), 
					false) -- not Unicode
	end
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " F:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", focus_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (focus_color), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " P:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", pl_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (pl_color), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " $:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", zeni_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("yellow"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " A:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", armor_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (armor_color), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " DR:",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", dr_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB (armor_color), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (promptWindow, "fn", "",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	if biomass > 0 then
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", " B:",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (promptWindow, "fn", shortenNumber(biomass),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode
	end

end


function onPromptShowRoundInfo(name, line, wildcards, styles)	
	purgeCurrentWindow()
	local leftTextPos = 4
	local heightTextStart = 0
	
	if foe_name ~= "" then
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Fighting! (",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", foe_name,
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode				
		leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ")",
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode
	end
	
	purgeCombatWindow()
	if hits_since_last_round + damage_dealt_since_last_round + hits_received_since_last_round + damage_received_since_last_round > 0 then	
		leftTextPos = 4
		heightTextStart = 0
		
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue("Hit x", tonumber(damage_dealt_since_last_round)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode		
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(tonumber(hits_since_last_round, 10), tonumber(damage_dealt_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("magenta"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(" [", tonumber(damage_dealt_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(tonumber(damage_dealt_since_last_round, 10), tonumber(damage_dealt_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("magenta"), 
					false) -- not Unicode		
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue("]   ", tonumber(damage_dealt_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("white"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue("Enemy hit x",tonumber(damage_received_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(tonumber(hits_received_since_last_round),tonumber(damage_received_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(" [",tonumber(damage_received_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode		
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue(tonumber(damage_received_since_last_round, 10),tonumber(damage_received_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("red"), 
					false) -- not Unicode	
		leftTextPos = leftTextPos + WindowText (combatWindow, "fn", stringIfValue("]",tonumber(damage_received_since_last_round, 10)),
					leftTextPos, heightTextStart, 0, 0,  -- rectangle
					ColourNameToRGB ("yellow"), 
					false) -- not Unicode		
	end
	hits_since_last_round = 0
	damage_dealt_since_last_round = 0
	hits_received_since_last_round = 0
	damage_received_since_last_round = 0
end

function drawPlayerThoughtcraft (successes_string, attempts_string, success_percent_string, is_success_string)
	purgeCurrentWindow()
	local leftTextPos = 4
	local heightTextStart = 0
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "(",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Thoughtcrafting ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("blue"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", is_success_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", ") ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "Successes: ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("blue"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", successes_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " out of ",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("blue"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", attempts_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", " (",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", success_percent_string,
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("cyan"), 
				false) -- not Unicode
	leftTextPos = leftTextPos + WindowText (currentWindow, "fn", "%)",
				leftTextPos, heightTextStart, 0, 0,  -- rectangle
				ColourNameToRGB ("white"), 
				false) -- not Unicode
end


function onThoughtcraftSucceed (name, line, wildcards, styles)
	thoughtcraft_attempts = thoughtcraft_attempts + 1
	thoughtcraft_successes = thoughtcraft_successes + 1
	drawPlayerThoughtcraft(tostring(thoughtcraft_successes), tostring(thoughtcraft_attempts), tostring(round((thoughtcraft_successes * 100) / thoughtcraft_attempts)), "succeeded!")	
end

function onThoughtcraftFail (name, line, wildcards, styles)
	thoughtcraft_attempts = thoughtcraft_attempts + 1
	drawPlayerThoughtcraft(tostring(thoughtcraft_successes), tostring(thoughtcraft_attempts), tostring(round((thoughtcraft_successes * 100) / thoughtcraft_attempts)), "failed!")
end

function onGetZeni (name, line, wildcards, styles)

	require "wait"
	wait.make (function ()
		wait.time(0.2)
		if show_battle_synopsis then
			wait.time (0.6)
		end 		
		local received_zeni = wildcards[1]
		ColourTell("white", "black", "    You found ",
			"yellow", "black", received_zeni,
			"white", "black", " zeni!\n")
	end)
end

function printFocusKi()
	ColourTell(
		"red", "black",		" _______ _______ _______ __   __ _______   ___   _ ___  \n",
		"red", "black",		"|       |       |       |  | |  |       | |   | | |   | \n",
		"red", "black",		"|    ___|   _   |       |  | |  |  _____| |   |_| |   | \n",
		"red", "black",		"|   |___|  | |  |       |  |_|  | |_____  |      _|   | \n",
		"red", "black",		"|    ___|  |_|  |      _|       |_____  | |     |_|   | \n",
		"red", "black",		"|   |   |       |     |_|       |_____| | |    _  |   | \n",
		"red", "black",		"|___|   |_______|_______|_______|_______| |___| |_|___| \n")
end

function printMeditate()
	ColourTell(
		"red", "black",		" __   __ _______ ______  ___ _______ _______ _______ _______ \n",
		"red", "black",		"|  |_|  |       |      ||   |       |   _   |       |       |\n",
		"red", "black",		"|       |    ___|  _    |   |_     _|  |_|  |_     _|    ___|\n",
		"red", "black",		"|       |   |___| | |   |   | |   | |       | |   | |   |___ \n",
		"red", "black",		"|       |    ___| |_|   |   | |   | |       | |   | |    ___|\n",
		"red", "black",		"| ||_|| |   |___|       |   | |   | |   _   | |   | |   |___ \n",
		"red", "black",		"|_|   |_|_______|______||___| |___| |__| |__| |___| |_______|\n"
		)	
end

function printStand()
	ColourTell(
		"red", "black",		" _______ _______ _______ __    _ ______    __   __ _______ \n",
		"red", "black",		"|       |       |   _   |  |  | |      |  |  | |  |       |\n",
		"red", "black",		"|  _____|_     _|  |_|  |   |_| |  _    | |  | |  |    _  |\n",
		"red", "black",		"| |_____  |   | |       |       | | |   | |  |_|  |   |_| |\n",
		"red", "black",		"|_____  | |   | |       |  _    | |_|   | |       |    ___|\n",
		"red", "black",		" _____| | |   | |   _   | | |   |       | |       |   |    \n",
		"red", "black",		"|_______| |___| |__| |__|_|  |__|______|  |_______|___|    \n")		
end

function onNeedFocus()
	is_low_on_focus = true
end
function resetCombatValues()
	combat_pl = 0	
	attacks = 0
	defends = 0
	blocks = 0
	dodges = 0
	misses = 0
	enemy_misses = 0
	soaks = 0
	enemy_soaks = 0
	hits = 0
	enemy_hits = 0
	damage_dealt = 0
	damage_received = 0
	total_damage_dealt = 0
	total_damage_received = 0
	total_attacks = 0
	total_defends = 0
	total_blocks = 0
	total_dodges = 0
	total_misses = 0
	total_enemy_misses = 0
	total_soaks = 0
	total_enemy_soaks = 0
	total_hits = 0
	total_enemy_hits = 0
	combats = 0
	overkill_counter = 0
	foe_name = ""
end

function onKilled (name, line, wildcards, styles)

	require "wait"
	wait.make (function ()
			ColourTell("red", "black", "You died! Damage received, last round: " .. damage_received_since_last_round)
			wait.time (1)
			onEndCombat(name, line, wildcards, styles)
	end)

end

function onEndCombat(name, line, wildcards, styles)	
	foe_health = 0

	require "wait"
	wait.make (function ()
		if show_battle_synopsis then
			wait.time (0.2)
			ColourTell("red", "black", "\n Fight's over!\n")
			wait.time (0.2)
			ColourTell("white", "black", "  Hit: ",
				"cyan", "black", tostring(hits),
				"cyan", "black", "(" .. tostring(round(hits * 100.0 / attacks)) .. "%)",
				"white", "black", " Miss: ",	
				"cyan", "black", tostring(misses + enemy_soaks),
				"cyan", "black", "(" .. tostring(round((misses + enemy_soaks) * 100.0 / attacks)) .. "%)",
				"white", "black", " DPH: ",
				"cyan", "black", tostring(round((damage_dealt + overkill_counter) / hits)),
				"white", "black", " Overkill: ",
				"cyan", "black", shortenNumber(overkill_counter),
				"white", "black", "\n")		
			if defends + enemy_hits + enemy_misses + soaks + blocks + dodges + damage_received > 0 then
				wait.time (0.2)
				ColourTell(
					"yellow", "black", "   (Enemy) Hit: ",
					"magenta", "black", tostring(enemy_hits),
					"cyan", "black", "(" .. tostring(round(enemy_hits * 100.0 / defends)) .. "%)",
					"yellow", "black", " Miss: ",
					"magenta", "black", tostring(enemy_misses + soaks + blocks + dodges),
					"cyan", "black", "(" .. tostring(round((enemy_misses + soaks + blocks + dodges) * 100.0 / defends)) .. "%)",	
					"yellow", "black", " Dmg: ",
					"red", "black", tostring(damage_received),	
					"yellow", "black", " (Avg:",
					"cyan", "black", tostring(round(nilZero(damage_received / enemy_hits))),
					"yellow", "black", ")",
					"white", "black", "\n")
			end
		else
			wait.time(0.6)
		end
		
		total_attacks = total_attacks + attacks
		total_defends = total_defends + defends
		total_blocks = total_blocks + blocks
		total_dodges = total_dodges + dodges
		total_misses = total_misses + misses
		total_enemy_misses = total_enemy_misses + enemy_misses
		total_soaks = total_soaks + soaks
		total_enemy_soaks = total_enemy_soaks + enemy_soaks
		total_hits = total_hits + hits
		total_enemy_hits = total_enemy_hits + enemy_hits
		total_damage_dealt = total_damage_dealt + damage_dealt
		total_damage_received = total_damage_received + damage_received
		
		damage_dealt = 0
		damage_received = 0
		attacks = 0
		defends = 0
		blocks = 0
		dodges = 0
		misses = 0
		enemy_misses = 0
		soaks = 0
		enemy_soaks = 0
		hits = 0
		enemy_hits = 0
		overkill_counter = 0
		hits_since_last_round = 0
		damage_dealt_since_last_round = 0
		hits_received_since_last_round = 0
		damage_received_since_last_round = 0
		
		foe_name = ""
		purgeCurrentWindow()
		purgeCombatWindow()
		purgeCombatWindow2()
		
		combats = combats + 1
	end)
end

function nilZero(obj)
	if obj ~= nil then
		return obj
	else
		return 0
	end
end


function onBlock (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	defends = defends + 1
	blocks = blocks + 1
end

function onSoak (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	defends = defends + 1
	soaks = soaks + 1
end

function onEnemySoak (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	enemy_soaks = enemy_soaks + 1
	attacks = attacks + 1
end

function onDodge (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	defends = defends + 1
	dodges = dodges + 1
end

function onEnemyMiss (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	defends = defends + 1
	enemy_misses = enemy_misses + 1
end

function onMiss (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	misses = misses + 1
	attacks = attacks + 1
end

function onTakeDamage (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	defends = defends + 1
	enemy_hits = enemy_hits + 1
	local dam_str = stripCommas(wildcards.damage)
	local dam_num = tonumber(dam_str, 10)
	damage_received = damage_received + dam_num
	
	hits_received_since_last_round = hits_received_since_last_round + 1
	damage_received_since_last_round = damage_received_since_last_round + dam_num
end

function onDealDamage (name, line, wildcards, styles)
	if wildcards.foename and foe_name == "" then
		foe_name = wildcards.foename
	end
	attacks = attacks + 1
	hits = hits + 1
	local dam_str = stripCommas(wildcards.damage)
	local dam_num = tonumber(dam_str, 10)
	damage_dealt = damage_dealt + dam_num
	--you can never do more than 100 damage in a single combat, this clamps it
	if damage_dealt > 100 then
		overkill_counter = overkill_counter + (damage_dealt - 100)
		damage_dealt = 100
	end
	
	hits_since_last_round = hits_since_last_round + 1
	damage_dealt_since_last_round = damage_dealt_since_last_round + dam_num
end

function onGainCombatPL(name, line, wildcards, styles)	
	onPromptShowRoundInfo(name, line, wildcards, styles)
	require "wait"	
	wait.make (function ()
		wait.time(0.4)
		if show_battle_synopsis then
			wait.time (0.6)
		end
		local num_str = stripCommas(wildcards[2])
		local pl_gained = tonumber(num_str, 10)
		combat_pl = combat_pl + pl_gained
		ColourTell("green", "black", "     Total PL+",
			"red", "black", shortenNumber(pl_gained),
			"green", "black", "\n")
	end)
end

function onAreaReset (name, line, wildcards, styles)
	require "wait"	
	wait.make (function ()
		wait.time(45)
		printReset()
	end)
end

function stringIfValue(str, num)
	if num > 0 then
		return str
	else 
		return ""
	end
end

function setPrompt (name, line, wildcards)
	local str = "prompt &WH[&R%h&W] K[&C%m&W/&c%M&W] F[&C%f&W]%Y&WP[&w%x&W|&z%p&W] $[&G$%g&W] A[&G%z&W/&g%Z&W] B[&R%Q&W]%Y&D"
	Send(str)
end

function setBattlePrompt (name, line, wildcards)
	local str = "fprompt &WH[&R%h&W] V[&r%y&W] K[&C%m&W/&c%M&W] F[&C%f&W]%Y&WP[&w%x&W|&z%p&W] $[&G$%g&W] A[&G%z&W/&g%Z&W] B[&R%Q&W]%Y&D"
	Send(str)
end

function onStartTraining (name, line, wildcards, styles)
	if wildcards.trainingStat then
		training_stat = wildcards.trainingStat
		times_gravity = tonumber(wildcards.timesGravity)
	end
	total_training_pl_gained = 0
	training_pl_gained = 0
end

function onStopTraining (name, line, wildcards, styles)	
	purgeCombatWindow()
	purgeCombatWindow2()
	if training_pl_gained > 0 and training_stat ~= "" then
		total_training_pl_gained = total_training_pl_gained + training_pl_gained
		ColourTell("green", "black", "Stopped training (",
					"cyan", "black", training_stat,
					"green", "black", ") at ",
					"cyan", "black", shortenNumber(times_gravity),
					"green", "black", " Gs - PL: ",
					"cyan", "black", shortenNumber(total_training_pl_gained),
					"green", "black", " (",
					"red", "black", "+" .. shortenNumber(training_pl_gained),
					"green", "black", ")\n")
		training_pl_gained = 0
	end	
	training_stat = ""
	training_flavor_text = ""
end

function onLootDrop (name, line, wildcards, styles)
	printWoot()
end

function printWoot()
ColourTell(
	"red", "black", " _     _ _______ _______ _______ \n",
	"red", "black", "| | _ | |       |       |       |\n",
	"red", "black", "| || || |   _   |   _   |_     _|\n",
	"red", "black", "|       |  | |  |  | |  | |   |  \n",
	"red", "black", "|       |  |_|  |  |_|  | |   |  \n",
	"red", "black", "|   _   |       |       | |   |  \n",
	"red", "black", "|__| |__|_______|_______| |___|  \n")
end

function onEarnedTrains (name, line, wildcards, styles)
	printTrains()
end

function printTrains()
ColourTell(
	"red", "black", " _______ ______   _______ ___ __    _ _______ \n",
	"red", "black", "|       |    _ | |   _   |   |  |  | |       |\n",
	"red", "black", "|_     _|   | || |  |_|  |   |   |_| |  _____|\n",
	"red", "black", "  |   | |   |_||_|       |   |       | |_____ \n",
	"red", "black", "  |   | |    __  |       |   |  _    |_____  |\n",
	"red", "black", "  |   | |   |  | |   _   |   | | |   |_____| |\n",
	"red", "black", "  |___| |___|  |_|__| |__|___|_|  |__|_______|\n")
end

function printReset()
ColourTell(
	"red", "black", " ______   _______ _______ _______ _______ \n",
	"red", "black", "|    _ | |       |       |       |       |\n",
	"red", "black", "|   | || |    ___|  _____|    ___|_     _|\n",
	"red", "black", "|   |_||_|   |___| |_____|   |___  |   |  \n",
	"red", "black", "|    __  |    ___|_____  |    ___| |   |  \n",
	"red", "black", "|   |  | |   |___ _____| |   |___  |   |  \n",
	"red", "black", "|___|  |_|_______|_______|_______| |___|  \n")
end

function printOmNom()
ColourTell(
	"red", "black", " _______ __   __ __    _ _______ __   __ \n",
	"red", "black", "|       |  |_|  |  |  | |       |  |_|  |\n",
	"red", "black", "|   _   |       |   |_| |   _   |       |\n",
	"red", "black", "|  | |  |       |       |  | |  |       |\n",
	"red", "black", "|  |_|  |       |  _    |  |_|  |       |\n",
	"red", "black", "|       | ||_|| | | |   |       | ||_|| |\n",
	"red", "black", "|_______|_|   |_|_|  |__|_______|_|   |_|\n")
end

function printSuppress()
ColourTell(
	"red", "black", " _______ __   __ _______ _______ ______   _______ _______ _______ \n",
	"red", "black", "|       |  | |  |       |       |    _ | |       |       |       |\n",
	"red", "black", "|  _____|  | |  |    _  |    _  |   | || |    ___|  _____|  _____|\n",
	"red", "black", "| |_____|  |_|  |   |_| |   |_| |   |_||_|   |___| |_____| |_____ \n",
	"red", "black", "|_____  |       |    ___|    ___|    __  |    ___|_____  |_____  |\n",
	"red", "black", " _____| |       |   |   |   |   |   |  | |   |___ _____| |_____| |\n",
	"red", "black", "|_______|_______|___|   |___|   |___|  |_|_______|_______|_______|\n")
end

function onThoughtcraftStart (name, line, wildcards, styles)
	purgeCurrentWindow()
	thoughtcraft_attempts = 0	
	thoughtcraft_successes = 0
end

function onThoughtcraftStop (name, line, wildcards, styles)
	purgeCurrentWindow()
	ColourTell("blue", "black", "You stop creating shards. Successes: ",
		"cyan", "black", tostring(thoughtcraft_successes),
		"blue", "black", " out of ",
		"cyan", "black", tostring(thoughtcraft_attempts),
		"blue", "black", " (",
		"cyan", "black", tostring(round((thoughtcraft_successes * 100) / thoughtcraft_attempts)),
		"blue", "black", "%)")
end

function onTrainingFlavorText (name, line, wildcards, styles)	
	training_flavor_text = wildcards[0]
end

function onBioSkillAbsorb (name, line, wildcards, styles)
ColourTell("palegreen", "black", "You absorb ",
	"cyan", "black", wildcards.skillName,
	"palegreen", "black", "!\n")
	printOmNom()
end

function onEnter5bWarning (name, line, wildcards, styles)
	if current_pl ~= nil and current_pl > 5000000000 then
		printSuppress()
	end
end

function cleanPacket (packetString)
	local culledString = string.gsub(packetString, "%[0;37m", "")
	culledString = string.gsub(culledString, "%[0;36m", "")
	culledString = string.gsub(culledString, "%[1;30m", "")
	culledString = string.gsub(culledString, "%[1;34m", "")
	culledString = string.gsub(culledString, "%[1;36m", "")
	culledString = string.gsub(culledString, "%[1;37m", "")
	culledString = string.gsub(culledString, "%[0m", "")
	culledString = string.gsub(culledString, "\\x1B", "") --scrape escape codes??
	culledString = string.gsub(culledString, "\n", "") -- scrape newlines...
	return culledString
end

function OnPluginPacketReceived (s) 
	--my strategy for simplifying the regex here is 
	--to cull the codes from the packet! It's unreadable!
	local culledString = cleanPacket(s)
	
	local startPrompt = string.find(culledString, "%b()")
	if startPrompt == nil then 
		return s
	end
	
	local promptString = string.sub(culledString, startPrompt + 1, -3)
	
	--this is me giving up on stupid fucking regex
	local indexOfLife = string.find(promptString, "L", 1, true)
	if indexOfLife then
		local indexOfKi = string.find(promptString, "K", indexOfLife, true)
		if indexOfKi then
			local indexOfPower = string.find(promptString, "P", indexOfKi, true)			
			if indexOfPower then
				return s .. "\n"
			end
		end
	else 
		indexOfLife = string.find(promptString, "D", 1, true)
		if indexOfLife then
			local indexOfKi = string.find(promptString, "E", indexOfLife, true)
			if indexOfKi then
				local indexOfPower = string.find(promptString, "T", indexOfKi, true)			
				if indexOfPower then
					return s .. "\n"
				end
			end
		end
	end
	
	return s
end -- function OnPluginPacketReceived

function debugPrompt ()
end
]]>
</script>
</muclient>
